---
title: "ETC5521 Assignment 1"
subtitle: "Contribution of domestic clubs towards world cup success in women's soccer"
team: wattle
author:
  - Ketan Kabu  31554679
  - Yiwen Zhang 31203019
date: "`r Sys.Date()`"
bibliography: references.bib
biblio-style: authoryear-comp
output: 
  bookdown::html_document2:
   citation_package: biblatex
   toc: TRUE
---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE, message=FALSE,warning = FALSE,comment = FALSE,fig.pos = 'H')

library(ggplot2)
library(tidyverse)
library(kableExtra)
library(dplyr)
library(plotly)
library(bookdown)
```

```{r readdata}
wwc_outcomes <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-07-09/wwc_outcomes.csv")
squads_raw <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-07-09/squads.csv")
codes <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-07-09/codes.csv")

```


# Introduction and motivation

Women's soccer has gained a lot of media attention in the last few years, and deservingly so. Countries like the USA, a dominant force in women's soccer, have produced some top quality players like Megan Rapinoe, Carli Lloyd, Alex Morgan and Julie Ertz. Just north of the USA, Christine Sinclair from Canada became the first player to win the Lou Marsh Award as Canadian Athlete of the Year, which is unsurprising considering her outstanding haul of 182 career international goals. Ada Hegerberg from Norway became the first woman to win the prestigious Ballon d'Or award, an yearly honor awarded to best player in the world, which was first introduced for the women's game in 2018.[@sportmob2020]

The advancement of women's soccer has been parallel with the understanding and acceptance of data and analytics in the game. The technological advancement in capturing and analysing data has exploded since the late 1990s, when it began. Clubs have used this technology to identify and scout talent from all over the world.

Every country has a different approach towards coaching and developing talent. Success at an international level could be down to the ability of world class players playing with a certain level of chemistry, which could be challenging as it is common for them to be playing for different rival clubs at the domestic level. In the men's game, we saw Italy, Spain and Germany winning world cups in 2006, 2010 and 2014 respectively. Many partly attributed the success of these teams towards the fact that majority of these players playing in the same domestic league (or country), or even in the same club, especially those clubs that produce the most successful international players.

In this paper, we will approach the women's game with the same lens. We believe that these findings could prove meaningful to coaches, scouts and even young players in the game looking to choose clubs to play for with future international success in mind.

Limitations - The squad data that we had access to had only the 2019 world cup team rosters, which is why we could only focus on the 2019 world cup matches. If similar dataset for all world cups is obtained, analysis can be done on all world cups and a trend observation can produce deeper insights about how nations have progressed in women's soccer. 
There is also a need to assess players' performance not solely on the basis of goals they scored. Midfielders, Defenders and Goalkeepers have various other parameters they can be judged on - like assists, distance covered in a match, tackles, clearances, saves(goalkeepers) and various others. If this information is available, better player performance insights can be achieved. 
We could also do match by match analysis of the world cup if we can obtain information about how each player was rated, or scored certain number of goals, in a world cup match.
In our clubs data, we have a reference named as "Unattached", which will appear sometimes in our analysis. This signifies that the player(s) is not contracted with any domestic club when the data was collected.


# Data description

This dataset is about Women's World Cup, which originally comes from website data.world <https://data.world/sportsvizsunday/womens-world-cup-data>.It consists of final score and win/loss status data from 1991-2019. Additionally, the 2019 world cup rosters for each team are included. After being cleaned by a data analyst, we downloaded the data from his github <https://github.com/rfordatascience/tidytuesday/tree/master/data/2019/2019-07-09>.
There are three .csv files in this dataset to manage and store the data, and they are named "codes", "squads" and "wwc_outcomes".  

"wwc_outcomes.csv" has seven variables:  
```{r}
head(wwc_outcomes)
```

- "year" represents the year of tournament,  
- "team" is the abbreviated team name,  
- "score" means the score by team, 
- "round" means the round of the tourament, includes: "Group", "Quarter Final", "Semi Final", "Third Place Playoff", "Final" and "Round of 16",   
    +) Ground: In the first stage (the "Group Stage"), the 32 teams are placed into eight groups of four teams each, The top two teams from each group advance to the second stage (the 'Knockout Stage'). If two or more teams finish even on points, tie-breakers are used: the first is 'goal differential' then total goals scored, then head-to-head results, and finally drawing of lots.  
    +) Round of 16:  the winner of each Group plays against the runner-up from another group  
    +) Quarter final  --> Semi Finals --> Final  
    +) Third place playoff: The losing semi-finalists play a match for third place.  
- "yearly_game_id" is a grouping variable for matches in each world cup,   
- "team_num" is 1 or 2 representing teams in each match, and  
- "win_status" represents a team win or loss. 

In "squads.csv":
```{r clean-squads}
# load the squad information for the remaining world cups
wc_squad_full <- read.csv(here::here("femalewwc_squad.csv")) %>%
  mutate(dob = as.Date(dob, format = "%d-%B-%Y"))

# Update missing info for squads_raw
squads_raw <- squads_raw %>%
  mutate(
    caps = case_when(
    str_detect(player, "Xu Huan") ~ 1,
    str_detect(player, "Lin Yuping") ~ 13,
    str_detect(player, "Wang Yan") ~ 28,
    str_detect(player, "Wang Ying") ~ 4,
    str_detect(player, "Li Wen") ~ 32,
    str_detect(player, "Bi Xiaolin") ~ 35,
    str_detect(player, "Yao Wei") ~ 14,
    str_detect(player, "Luo Guiping") ~ 1,
    str_detect(player, "Liu Yanqiu") ~ 2,
    TRUE ~ caps
  ),
  goals = case_when(
    str_detect(player, "Xu Huan") ~ 0,
    str_detect(player, "Lin Yuping") ~ 0,
    str_detect(player, "Wang Yan") ~ 0,
    str_detect(player, "Wang Ying") ~ 0,
    str_detect(player, "Li Wen") ~ 3,
    str_detect(player, "Bi Xiaolin") ~ 0,
    str_detect(player, "Yao Wei") ~ 3,
    str_detect(player, "Luo Guiping") ~ 0,
    str_detect(player, "Liu Yanqiu") ~ 0,
    TRUE ~ goals)
  )
    
# row binds with 2019 squad info
squads <- squads_raw %>%
  mutate(year = 2019) 
squads <- squads %>%
  rbind(wc_squad_full)

# manually fix the name of some clubs to avoid mismatch
squads <- squads %>%
  mutate(club = case_when(
    str_detect(club, "Olympique Lyon") ~ "Lyon",
    str_detect(club, "Olympique Lyonnais") ~ "Lyon",
    str_detect(club, "Ajax") ~ "AFC Ajax",
    str_detect(club, "AIK Fotboll") ~ "AIK",
    str_detect(club, "Asker S.K.") ~ "Asker SK",
    str_detect(club, "Avaldsnes") ~ "Avaldsnes IL",
    str_detect(club, "Bangkok F.C.") ~ "Bangkok",
    str_detect(club, "Klepp") ~ "Klepp IL",
    str_detect(club, "Urawa Red Diamonds") ~ "Urawa Red Diamonds Ladies",
    str_detect(club, "Urawa Reds Ladies") ~ "Urawa Red Diamonds Ladies",
    str_detect(club, "Linköping FC") ~ "Linköping",
    str_detect(club, "Arna-Bjørnar") ~ "Arna-Bjornar",
    str_detect(club, "Arsenal L.F.C.") ~ "Arsenal",
    str_detect(club, "Bayelsa Queens FC") ~ "Bayelsa Queens",
    str_detect(club, "Beijing Chengjian") ~ "Beijing Chenjian",
    str_detect(club, "Birmingham City L.F.C.") ~ "Birmingham City",
    str_detect(club, "Changchun Zhuoyue [zh]") ~ "Changchun Zhuoyue",
    str_detect(club, "Chelsea L.F.C.") ~ "Chelsea",
    str_detect(club, "Delta Queens FC") ~ "Delta Queens",
    str_detect(club, "Djurgården") ~ "Djurgårdens IF",
    str_detect(club, "Doncaster Rovers Belles LFC") ~ "Doncaster Rovers Belles",
    str_detect(club, "Eastern Suburbs AFC") ~ "Eastern Suburbs",
    str_detect(club, "Everton L.F.C.") ~ "Everton",
    str_detect(club, "FC Barcelona") ~ "Barcelona",
    str_detect(club, "FFC Frankfurt") ~ "1. FFC Frankfurt",
    str_detect(club, "FFC Turbine Potsdam") ~ "1. FFC Turbine Potsdam",
    str_detect(club, "KIF Örebro DFF") ~ "KIF Örebro",
    str_detect(club, "Kolbotn Fotball") ~ "Kolbotn",
    str_detect(club, "Kristianstads DFF") ~ "Kristianstads",
    str_detect(club, "Levante UD") ~ "Levante",
    str_detect(club, "Louves Miniproff [de]") ~ "Louves Minproff",
    str_detect(club, "LSK Kvinner FK") ~ "LSK Kvinner",
    str_detect(club, "Melbourne Victory FC") ~ "Melbourne Victory",
    str_detect(club, "Montpellier") ~ "Montpellier",
    str_detect(club, "Nasarawa Amazons FC") ~ "Nasarawa Amazons",
    str_detect(club, "Pelican Stars FC") ~ "Pelican Stars",
    str_detect(club, "Piteå") ~ "Piteå",
    str_detect(club, "Rivers Angels FC") ~ "Rivers Angels",
    str_detect(club, "Sevilla FC") ~ "Sevilla",
    str_detect(club, "Sky Blue FC") ~ "Sky Blue",
    str_detect(club, "Stabæk Fotball") ~ "Stabæk",
    str_detect(club, "Tianjin Teda F.C.") ~ "Tianjin Teda",
    str_detect(club, "Trondheims-Ørn SK") ~ "Trondheims-Ørn",
    str_detect(club, "Tyresö FF") ~ "Tyresö",
    str_detect(club, "Umeå IK") ~ "Umeå",
    str_detect(club, "Valencia CF") ~ "Valencia",
    str_detect(club, "Vegalta Sendai") ~ "Vegalta Sendai Ladies",
    str_detect(club, "Vittsjö GIK") ~ "Vittsjö",
    str_detect(club, "Wuhan Jianghan University [zh]") ~ "Wuhan Jianghan Univ.",
    str_detect(club, "SwedenJitex BK") ~ "Jitex BK",
    str_detect(club, "EnglandNotts County") ~ "Notts County",
    TRUE ~ club
  ))
```

- "squad_no" is the player jersey number from 1 to 23,  
- "country" shows the country of the team,  
- "pos" is the position of player,  
- "player" shows the name of the player,  
- "dob" is date of birth,   
- "age" is the players' ages,  
- "caps" displays the number of international games played by the player,  
- "goal" is the number of international goals scored by the player, and  
- "club" shows which domestic club the player belongs to.

# Analysis and findings

The analysis is mainly divided into three parts, which answer the three secondary questions, and they are :

Primary question: What would describe the Worldcup participants and most importantly, if possible, the world cup winner?

- Which are the clubs that provide the most number of world cup players?

- How about contribution by clubs in terms of players' caps and positions?

- How is the performance of successful clubs in the 2019 World Cup?

# Changes from Assignment 1:
In the previous stage of this report, the **wattle** team had performed a range of analysis on the player contribution by club, goals score. player's cap and player position. Even though the analysis was done thoroughly, the works lacked direction towards answering the primary question. In this improvised version, we tried to re- address the wattle team's analysis by expanding the scope (by obtaining more data) to direct the results towards answering the primary question.  

Details of change are as follow:   
- Primary question was introduced, and small questions were added and revised to better facilitate the primary question.  
- Report structure: We introduced a new primary question and a set of small questions. Thus the report was restructured to reflect the appearance of new questions.  
- Data description: We obtained more data, so we do further introduction. Also the missing values analysis was conducted on both the new and old datasets.  
- Part 3.1 _Clubs that provided the most number of world cup players_:  
  +) We relocated the _Overall contribution_ to under the new _Analysys by club_ and expanded the work using the data of other World Cup tournaments as well.  
  +) The _Goal scorers_ was removed as we wanted to discuss the relationship among the age, caps and the goals to dertermine the characteristic of a World Cup player.  
- Part 3.2 _Cap contribution by clubs_:  
  +) The _Contribution by clubs in terms of players’ caps_ was relocated to under the new _Analysys by players_.  
  +) The _Clubs that provide players that are young and also highly experienced_ was removed as we will discuss the players'age in a seperate section under the _Analysys by players_ section.  
  +) The _Contribution by clubs in terms of player position_ was removed as we deemed unrelevant to the main question and contained less usefull information.  
- Conclusion: new conclusion to associate with new analysis.  

_________________________________________________________________________________________
NEW STRUCTURE from here

## Analysis by country

```{r}
# read the fifa code
fifa_code <- read.csv(here::here("fifa_country_code.csv"))

# reference the country code in the wwc_outcomes
wwc_outcomes_fullname <- wwc_outcomes %>%
  left_join(codes, by = "team")
```


```{r team-result}
# count the number of rounds participated by each country
team_count <- wwc_outcomes_fullname %>%
  select(country, year, score) %>%
  count(country, year) %>%
  rename("rounds" = n)
# calculate the result for each team
team_result <-wwc_outcomes_fullname %>%
  select(country, year, score) %>%
  group_by(country, year) %>%
  summarise(total_score = sum(score)) %>%
  ungroup()
# bind the two tables to calculate avg score/ round
avg_score_per_round <- team_result %>%
  left_join(team_count, by = c("country", "year")) %>%
  mutate(avg_score = total_score/rounds)
```


## Analysis by club

To find out what factors could determind a World Cup player, we tried to looked at two elements of her career: the player herself and the club that she played for in her normal time not attending the World Cup. In this section, we will have a look at the club first.  
It's no surprise when we would see some clubs or leagues that better represents the players than the others. Those clubs usually are big in size, providing more resources to produce a quality player. In the figure below, we will examine the biggest 12 clubs that are or were home to the highest numbers of World Cup players.  

```{r player-contri, fig.cap = "Contribution of World Cup players by clubs from 2007 to 2019"}
wc_clubs_players <- squads %>% 
  # leave the unattached out to count
  # filter out 2003 as clubs info were missing
  filter(year > 2003,
         !club == "Unattached") %>%
  group_by(club) %>%
  # count the unique players only as one player could attend more than one WC
  summarise("Player" = n_distinct(player)) %>% 
  arrange(desc(Player))

wc_clubs_players %>% 
  head(12) %>% 
  kable(booktabs = TRUE, caption = "Contribution of World Cup players by clubs from 2007 to 2019") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

We filtered for the 2007 World Cup up to 2019 World Cup (4 tournaments in total) as the club's information was not fully provided for all of the prior tournaments. After that we counted the number of unique players that each club had brought to the World Cup. 

Lyon contributed the highest number of players throughout the four World Cup tournaments. Asides from Lyon, the France Women's First Division League had another national clubs got into the top 10, which was Paris Saint-Germain. Most of the other clubs in the ranking saw themselves belonged to the countries that are most well-known for their football history. They are Germany (1. FFC Frankfurt and VfL Wolfsburg), England (Arsenal and Chelsea), Norway (LSK Kvinner), Sweden (Linköping), Canada (Vancouver Whitecaps) and Spain (Barcelona).  

We have two special cases that top the chart: 25-Apr of North Korea and Rivers Angels of Nigeria. These two clubs were special in their own way that their national World Cup teams mostly consisted of their players. We will revisit this point again when we get to the breakdown of Domestical and Foreign elements of these 12 clubs later in this section.   

```{r top-10-by-year, fig.cap = "Clubs' players by year from WC2007-WC2019"}
squads %>% 
  # filter top twelve only
  filter(club %in% c("Lyon", "Arsenal", "Paris Saint-Germain", "1. FFC Frankfurt", "25-Apr",
                     "Barcelona", "Rivers Angels", "Chelsea", "Vancouver Whitecaps", "VfL Wolfsburg",
                     "Linköping", "LSK Kvinner"),
         year > 2003) %>%
  group_by(club, year) %>%
  # leave the unattached out to count
  # filter out 2003 as clubs info were missing
  summarise("Player" = n_distinct(player)) %>% 
  arrange(club, year) %>%
  ggplot(aes(x = factor(year), Player)) +
  geom_col(stat = "identity") +
  facet_wrap(~ club) +
  theme_bw() +
  xlab("year") +
  ggtitle("Clubs' players by year from WC2007-WC2019")
```

In terms of year, 5 out of the 12 clubs featured in the chart did not join the whole four World Cups. We can see clearly from the chart that 25-Apr had made an impressive contribution of players for the North Korea team in 2007 and 2011, which brought them to our ranking even though they dropped out in the recent two games. 

Except for Chelsea and Barcelona, other clubs did not observe a significant change in the number of World Cup player in 2019. Rather, most of them went down in numbers. There is a couple of explanations that might explain this overvation:  
- 2015 was the first year that allowed the number of participated teams to increased from 16 in 2011 to 24. As a result, we will see that most clubs saw theie players surged in number in 2015.  
- There is a fact in the football industry that big clubs usually hestitated to send their prominant players to the World Club. They want to reserve their stars for the national tournaments or other premier leagues. In the male football industry, this practice threatened the success of World Cup so bad that FIFA even comes up with a commission scheme to pay the clubs for their "collaboration" [@reuters]. A drop in the female players'number could suggest two things: (1) the women's football clubs also concerned for other games that they did not want to send away their star players, and (2) 2019 was the second World Cup that allowed 24 teams to participate. Other clubs might have used this chance to send their players to the international field, making the share smaller for all.  

For (1), we was confirmed that FIFA has announced the first beneficial package to promote the clubs for participating in the Women's World Cup. This program was introduced ahead of the World Cup 2019. More details can be read [here](https://img.fifa.com/image/upload/imn0xwvea97tommxx5uz.pdf).  

Finally in this club section, we will look at the composition of the players that each of these 12 clubs sent to World Cup. Would they be playing along or against their comrades?

```{r top-12-by-year, fig.cap = "Percentage of domestical player of top 12"}
# Count the distinct nationals in each club in top 12
domestic <- squads %>% 
  # filter top 12 only
  filter(club %in% c("Lyon", "Arsenal", "Paris Saint-Germain", "1. FFC Frankfurt", "25-Apr",
                     "Barcelona", "Rivers Angels", "Chelsea", "Vancouver Whitecaps", "VfL Wolfsburg",
                     "Linköping", "LSK Kvinner"),
         year > 2003) %>%
  group_by(club, country) %>%
  # leave the unattached out to count
  # filter out 2003 as clubs info were missing
  summarise("Player" = n_distinct(player)) %>%
  ungroup()

# Visualise the combination of domestical and foreign elements
domestic %>%
  group_by(club) %>%
  # all clubs will have majority of their players coming from the country
  mutate("origin" = ifelse(Player == max(Player), "Domestic", "Other"),
         prop = Player/sum(Player)) %>%
  group_by(club,origin) %>%
  summarise(prop = sum(prop)) %>%
  filter(origin == "Domestic") %>%
  ggplot(aes(fct_reorder(club, prop), prop)) +
  geom_col(stat = "identity", colour = "blue", fill = "blue") +
  coord_flip() +
  theme_bw() + 
  ylab("club") +
  xlab("% Domestical Player") +
  ggtitle("Percentage of domestical player of top 12")
```

We can see that Vancouver Whitecaps, 25-apr and Rivers Angels had most of their World Cup players coming from their own country. Other big names like Chelse, Arsena, Lyon or 1. FFC Frankfurt hold only 50% - 60% of their World Cup players domestic, other were exported. To understand better about how such composition would contribute to their performance in World Cup, we were tempted to see of all the international clubs featured in the World Cup, which one hold the highest of players and how would that related to their performance. However, the task of gathering the nation of each club took a lot of time and hand works, hence we refered to a study by FIFA for this question.

```{r fifa-research, fig.cap = "Players owner in World Cup 2019", out.height = "60%"}
knitr::include_graphics(here::here("wc_owner.png"))
```

In an article published on dw.com[@fifa], FIFA has released their figures showing that US club held roughly 14% of total World Cup 2019 player - 73 players. That figure was very impressive if you consider there were hundreds of clubs from all over the world sending their players to the game. Followed behind were our familiar faces of Spain, France and England. The article also pointed out that Spain's national women team qualified for the game first time in 2015, by that team, there were only 21 of the players belonged to the top Spanish teams. In 2019, the number increased to 51. The article also suggested that this change came from a significant improve in supports for women's football in Spain in the recent years. 

The domination of US and the rising of Spain suggested how a nation would support their players. It was of nature that players would come to the clubs that offered them the best of conditions. The better the condition, the more likely to attract top players and finally the better performance at any tournament. The United States had crowned the championship at the World Cup for 4 times out of 8 times the Women World Cup was held until now.  

## Analysis by player
Next we will take a look deeper into the stars of the game - the players. In this section, we wanted to know if there are any factors that would determine a player's chance to participate in the World Cup, or even further, how these factors can tell about the performance of such player in the game.  

### Player's age
First of all, we will look at the over age distribution of all the players through all eight World Cup tournaments.

```{r player-age, fig.cap = "Player's age distribution"}
squads %>%
  ggplot(aes(x = age)) +
  geom_histogram(binwidth = 1 , color = "black", fill = "magenta") +
  theme_bw()+
  facet_wrap(~ year) +
  ggtitle("Player's age distribution")
```

We chosed the bindwith equals to 1, each bindwith represented 1 year of age. We could ignore the count for each year as the number of teams participated were not similar for the all the years. Instead we will concentrate on the distribution. 

We can see that the age distribution by year varied quite significantly. From 1991 up to 2015, the age distribution was lightly right skewed, meaning players cluttered around the lower age - lower than 30 , around 20- 25 as we can refer from the charts. But coming to 2019, a clear shift was observed where the age cluttered around the higher age of 27. More observations were observed at further beyond 30, indicating that players that qualified for World Cup are getting older than before.  

Next up, we will comb through the age of all participants that took part in World Cup from the very first tournament in 1991 to the most recent in 2019.  

```{r country-age, fig.cap = "Summary of player age by country"}
player_age <- squads %>%
  group_by(year, country) %>%
  mutate(dummy = ifelse(country %in% c("US", "Norway", "Germany","Netherlands", "Japan", "China PR", "Sweden", "Brazil"),1, 0)) 

pa <- player_age %>%
  ggplot(aes(reorder(country, age, FUN = median), age, color = dummy)) +
  geom_boxplot() +
  theme_bw() +
  theme(axis.text.x=element_text(angle=90, hjust=1),
        legend.position = "none") +
  xlab("country") +
  ggtitle("Summary of player age by country")

ggplotly(pa)
```

On average, a World Cup player would not be younger than her 20s. The ideal age range for players would be around 25 to 27 years. The World Cup had witnessed a fair share of matured players who rocked the age of past 30s and even reached the 40s in history. Let's located the winners and the runners up for all of the past World Cup and see how the ages varied.

We have United States (4 wins, 1 runner up), Norway (1 win, 1 runner up), Germany (2 wins, 1 runner up), Japan (1 win, 1 runner up), China PR, Sweden, Brazil and Netherlands (each had 1 runner up). I have highlighted the countries mentioned in the chart above for easier reference. We can see that most of the countries resided on the right half of the chart, indicating a higher than average median age of players. The 4-time champion US even had a long right tail where the maximum age could reach 39. Other highlighted countries also possessed some players with the age felt into the outliers that passed 35. We have Japan and China on the other half of the chart, with China seems to have younger ladies than the others. Japan eventhough on the other half, had a long right tail of age distribution where players can get to the age of 36. 

### Player's cap

The number of caps of each player represents the number of times a player represents her team in an international play ground. 

Table \@ref(tab:arrangecapped) below summarised top 10 players with the highest caps in the history of World Cup, along with the country they presented, their positions, the clubs they played for and their caps and goals at the most recent time they participated in the World Cup. 

```{r arrangecapped}
most_capped <- squads %>%
  filter(year > 2003,
         !club == "Unattached") %>%
  select(-age, - squad_no) %>%
  group_by(player) %>%
  arrange(desc(year)) %>%
  slice(1) %>%
  arrange(desc(caps))

most_capped %>%
  head(10) %>%
  kable(caption = "Top 10 players with the highest caps") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

Again, the US took up the majority of ranks in the ranking table, 4 out of 10. Among which, Kristine Lilly hold the highest records at the World Cup 2007 - her last World Cup before retirement. After that and up until now, no players has been able to surpass her. Christie Rampone got the closest at the moment with 32 caps in difference.

We will look further and compare the caps countries to countries. For this task, we would take into focus only two years 2015 and 2019, as the two cyears had the same number of participating teams, making it easier to compare countries.

However, for 2019, we had to cross Nigeria and Cameroon off the list as these two countries missed a lot information regrading the caps and the goals. The result figure is presented below:

```{r cap-by-year, fig.cap = "Comparison of cap bar by year"}
capped_2019 <- most_capped %>%
  # filter countries with NA
  filter(year == 2019,
         !country %in% c("Nigeria", "Cameroon")) %>%
  group_by(country) %>%
  ggplot(aes(reorder(country, caps, FUN = median, na.rm = TRUE), caps)) +
  geom_boxplot() +
  theme_bw() +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  xlab("country in 2019") +
  coord_flip()
  ggtitle("Summary of player cap by country")
  
capped_2015 <- most_capped %>%
  filter(year == 2015) %>%
  group_by(country) %>%
  ggplot(aes(reorder(country, caps, FUN = median), caps)) +
  geom_boxplot() +
  theme_bw() +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  xlab("country in 2015") +
  coord_flip()
  ggtitle("Summary of player cap by country")
  
capped_both <- grid.arrange(capped_2019,capped_2015, ncol = 2)
```

Surprisingly, the US team, eventhough still at the top, actually had their caps lowering in 2019 compared to 2015, with only Carli Lloyd having the caps high enough to become an outliner. Most of the celebrity teams (teams that had won and achieved runner up), except for China PR and Brazil, saw their median caps dropped. Expanding further from the top 10 highest cap in table \@ref(tab:arrangecapped) above to the top 30, we only had 12 players who participated in the World Cup 2019. Whilst we cannot calculate the impact of such drops on the teams' performance (US still won and Netherlands was the runner up in 2019), we can try to explain the reasons behind such drop in caps.

It could possibly mean that the celebrity team either (1) had their prestige players reaching the retirement age (If you revisit the top 10 table, you would see that most players in top 10 born in late 70s and early 80s) so they had to drop out of the tournament or (2) the celebrity team considered to save their ace players for other premier leagues rather than exhaust them in World Cup. Whilst we can infer the assumption (1) from the date of birth provided, we had no solid base for the assumption (2). All we know at the moment is that FIFA has stepped in to encourage the teams to "collaborate" in exchange for a handsome commission under the form of supports given to the clubs to help build up their talents. 

### Performance

Explore the relation between the cap, the age and the goals

```{r}
library(GGally)
# filter out 2003 and forwards due to the lack of info
squads %>% 
  filter(year > 2003) %>%
  ggscatmat(columns = 6:8, color = "year") +
  scale_colour_brewer(palette="Set1") +
  theme_bw()
```




NEW STRUCTURE end here
_________________________________________________________________________________________






## Clubs that provide the most number of world cup players:

### Overall contribution



## Cap contribution by clubs

Out of a total of 552 players that featured in the 2019 World Cup, it can be seen in Table \@ref(tab:player-contri) that 15 play domestic football in Barcelona (Spain), 14 play for Lyon (France) and 12 play for Chelsea (England). It is interesting to note that clubs with 11 or higher number in this table can play in a match with a squad that's comprised entirely of world cup internationals, greatly increasing the profile of their club's brand.

> Not really, other players from other nations can also play for the club. Also club team members can actually go against rather than along each other. 

### Goal scorers

Now, let us look at the number of overall international goals scored by players that featured in the 2019 World Cup by clubs: 

```{r goal-contri}
wc_clubs_goals <- squads %>% 
  group_by(club) %>% 
  summarise(Goals = sum(goals)) %>% 
  arrange(desc(Goals))

wc_clubs_goals %>% 
  head(10) %>% 
  kable(booktabs = TRUE, caption = "Top Ten Clubs Providing Best Goal Scorers") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
  
```

Looking into Table \@ref(tab:goal-contri), Portland Thorns (247) and Orlando Pride (240) both are from the US. They make up for nearly 500 international goals between their players. Lyon (177), Arsenal (148), Barcelona (134) and Chelsea (133) make up the rest of the top 5 clubs. Let us deep dive into these teams and look into players that actually do the goal scoring.

```{r players-goals,fig.cap="Players v/s Goals Scored For International Team"}
players_goals <- squads %>% 
  group_by(club) %>% 
  mutate(Club_goals = sum(goals)) %>% 
  filter(Club_goals >= 133) %>% 
  arrange(desc(goals)) %>% 
  slice(1:5)


p1 <- players_goals %>% 
  ggplot(aes(player, goals, color = club, size = Club_goals)) + 
  geom_point() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  xlab("Players") +
  ylab("Goals") +
  ggtitle("Players v/s Goals Scored For International Team") +
  labs(size = "", color = "")

ggplotly(p1) 
  
```

In Figure \@ref(fig:players-goals), we can see the number of international goals scored by players belonging to the top 6 clubs (colored) contributing to the highest goal scorers, and the size indicates the amount of goals contributed by that player's club.

It is rather interesting to note that Portland Thorns, the club with the most number of international goals (247), has one player Christine Sinclair that contributes to 181 goals for her national team Canada. Without her, Portland Thorns would drop steeply in these rankings, instead of being number 1.

Orlando Pride on the other hand have two major players. Marta (110) and Alex Morgan (101) make up for the majority of international goals for the club. Even though both these clubs from Portland and Orlando are American, among these top 3 scorers only 1 - Alex Morgan, is actually of American nationality. Sinclair and Marta are Canadian and Brazilian respectively.

Lyon, Arsenal, Barcelona and Chelsea have players contributing more equally towards the international goals tally than Portland Thorns and Orlando Pride.

We can conclude in this section alone that in terms of the sheer number of players featuring in the 2019 World Cup, Barcelona has the highest contribution (15), followed by Lyon (177). In terms of goals, however, the American clubs Portland Thorns and Orlando Pride have a massive haul of nearly 500 goals between them, sitting quite comfortably at number 1 and 2 respectively. But Barcelona and Lyon also feature in the top 5 for goals contributed.


### Contribution by caps

We notice that the top five capped players are all over 30 years old! Is there any relationship between caps and the age of players? 
To answer this question, we made a plot of caps changing by age. In Figure \@ref(fig:international)，the purple curve represents the trend of caps with age, while the blue curve represents the trend of conditional mean value of caps with age. 

```{r international, fig.cap="caps changing with age"}
p0 <- ggplot(most_capped,
       aes(x= age, 
           y = caps)) +
  geom_line(color = "purple") +
  geom_smooth(se = FALSE) +
  xlab("Age") +
  ylab("Number of international games") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  ggtitle("The number of international games changing with age") 

ggplotly(p0)
```

Conditional mean refers to the average level of caps predicted under the fixed age, so the characteristics of caps changing with age can be obtained more intuitively by observing the blue line. [@geomsmoothggplot2]It can be seen that the blue line shows an upward trend with the increase of age, that is to say, the older a player is, the more times he participates in international competitions. It's not hard to understand that the older he is, the longer his career may be, the more games he will play.
But we can't help but wonder whether there are players who are both young and highly capped? What club is he from?

### Clubs that provide players that are young and also highly experienced

First of all, we set the age under 25 as "young", and the caps value higher than the mean value belongs to "highly capped", and then it comes to analysis. We then made a summary to get the mean value of caps and the results are in Table \@ref(tab:capyoung). The mean value of caps is 22.45, which means the player with caps higher than 22.5 can be called "highly experienced".
```{r  capyoung}
capped_young <- squads %>%
  filter(age <= 25) %>%
  arrange(desc(caps)) 

capped_young %>%
summary() %>%
  head(5)%>%
  kable(booktabs = TRUE, caption = "Summary of clubs with players under 25 years old") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

Then we select the players whose caps are higher than 22.5, and we present the top five players with their clubs in Table \@ref(tab:five).
It can be seen that clubs Paris Saint-Germain, Lyon and Orlando Pride all provide both young and highly capped players. Specifically, there are two qualified players from the same club Orlando Pride, which means that it may be a club with more young players and places relatively more importance in training newer players.
```{r five}
capped_young_highly <- capped_young %>%
  filter(caps >= 22.15) 

capped_young_highly %>%
  head(5)%>%
  kable(booktabs = TRUE, caption = "Top five clubs providing both young and highly capped players") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```


### Contribution by clubs in terms of player position

Let us now take a look at player positions. Broadly, we have 4 major positions to consider - Goalkeepers (GK), Defenders (DF), Midfielders (MF) and Forwards (FW). Our objective in this section would be to understand which clubs specialize in providing world cup international players in a particular playing position.

```{r play-pos}
GK <- squads %>% 
  filter(pos == "GK") %>% 
  group_by(club) %>% 
  tally() %>% 
  rename(Clubs_Gks = n)

GK_caps <- squads %>% 
  filter(pos == "GK") %>% 
  group_by(club) %>% 
  summarise(Clubs_Gk_caps = sum(caps))

DF <- squads %>% 
  filter(pos == "DF") %>% 
  group_by(club) %>% 
  tally() %>% 
  rename(Clubs_Dfs = n)

DF_caps <- squads %>% 
  filter(pos == "DF") %>% 
  group_by(club) %>% 
  summarise(Clubs_Df_caps = sum(caps))

MF <- squads %>% 
  filter(pos == "MF") %>% 
  group_by(club) %>% 
  tally() %>% 
  rename(Clubs_Mfs = n)

MF_caps <- squads %>% 
  filter(pos == "MF") %>% 
  group_by(club) %>% 
  summarise(Clubs_Mf_caps = sum(caps))

FW <- squads %>% 
  filter(pos == "FW") %>% 
  group_by(club) %>% 
  tally() %>% 
  rename(Clubs_Fws = n)

FW_caps <- squads %>% 
  filter(pos == "FW") %>% 
  group_by(club) %>% 
  summarise(Clubs_Fw_caps = sum(caps))

squads_pos <- squads %>% left_join(GK, by = "club")
squads_pos <- squads_pos %>% left_join(DF, by = "club")
squads_pos <- squads_pos %>% left_join(MF, by = "club")
squads_pos <- squads_pos %>% left_join(FW, by = "club")

squads_pos <- squads_pos %>% left_join(GK_caps, by = "club")
squads_pos <- squads_pos %>% left_join(DF_caps, by = "club")
squads_pos <- squads_pos %>% left_join(MF_caps, by = "club")
squads_pos <- squads_pos %>% left_join(FW_caps, by = "club")

squads_pos[is.na(squads_pos)] <- 0

```

```{r Goalkeepers, fig.cap="Clubs With Goalkeepers Featuring In 2019 WC"}
p2GK <- squads_pos %>%
  filter(Clubs_Gks > 1 | Clubs_Gk_caps >= 61) %>%
  group_by(club) %>% 
  ggplot(aes(club, as.factor(Clubs_Gks), size = Clubs_Gk_caps, color = club)) +
  geom_point() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  xlab("Clubs") +
  ylab("Number of WC GKs per club") +
  ggtitle("Clubs With Goalkeepers Featuring In 2019 WC") +
  labs(size = "", color = "")

ggplotly(p2GK)
```

Goalkeepers, figure \@ref(fig:Goalkeepers) - Arsenal, Chelsea, Goteborg, Rivers Angels, Vfl Wolfsburg and Vittsjo have 2 goalkeepers that featured in 2019 World Cup. Out of these, Chelsea has the highest cap count of 173 for their two goalkeepers. It is interesting to note that Chelsea's north London neighbours Arsenal also have 2 goalkeepers with a combined cap count of 53. It can be perceived that London is a good city for goalkeepers to play professionally to achieve international success.

```{r Defenders, fig.cap="Clubs With Defenders Featuring In 2019 WC"}
p2DF <- squads_pos %>%
  filter(Clubs_Dfs >= 4 | Clubs_Df_caps >= 214) %>%
  group_by(club) %>% 
  ggplot(aes(club, as.factor(Clubs_Dfs), size = Clubs_Df_caps, color = club)) +
  geom_point() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  xlab("Clubs") +
  ylab("Number of WC DFs per club") +
  ggtitle("Clubs With Defenders Featuring In 2019 WC") +
  labs(size = "", color = "")

ggplotly(p2DF)
```

Defenders, figure \@ref(fig:Defenders) - Lyon dominates this position. They have a whopping 7 defenders that featured in the 2019 World Cup, with a combined total experience of 475 international caps. Not far behind though is Chelsea with 6 defenders and 404 caps between them.

```{r Midfielders, fig.cap="Clubs With Midfielders Featuring In 2019 WC"}
p2MF <- squads_pos %>%
  filter(Clubs_Mfs >= 3 | Clubs_Mf_caps >= 191) %>%
  group_by(club) %>% 
  ggplot(aes(club, as.factor(Clubs_Mfs), size = Clubs_Mf_caps, color = club)) +
  geom_point() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  xlab("Clubs") +
  ylab("Number of WC MFs per club") +
  ggtitle("Clubs With Midfielders Featuring In 2019 WC") +
  labs(size = "", color = "")

ggplotly(p2MF)
```

Midfielders, figure \@ref(fig:Midfielders) - Barcelona, Juventus, Manchester City, Nippon TV Beleza, Vfl Wolfsburg and Washington Spirit all have 4 midfielders represented in the 2019 World Cup. Vfl Wolfsburg have the most experience within their 4 midfielders, with a massive 366 caps between them. Paris Saint-Germain has 3 midfielders but a second highest total of caps between them, of 273. Rosengard has only 1 midfielder, the Swedish national Caroline Seger who has 193 caps alone for her country.

```{r Forwards, fig.cap="Clubs With Forwards Featuring In 2019 WC"}
p2FW <- squads_pos %>%
  filter(Clubs_Fws >= 3 | Clubs_Fw_caps >= 181) %>%
  group_by(club) %>% 
  ggplot(aes(club, as.factor(Clubs_Fws), size = Clubs_Fw_caps, color = club)) +
  geom_point() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  xlab("Clubs") +
  ylab("Number of WC FWs per club") +
  ggtitle("Clubs With Forwards Featuring In 2019 WC") +
  labs(size = "", color = "")

ggplotly(p2FW)
```

Forwards, figure \@ref(fig:Forwards) - Barcelona is the only club that boasts 5 of their forwards featuring in the 2019 World Cup, with a combined experience of 249 caps between them. Portland Thorns has 4 forwards, but their combined experience of 534 caps easily overshadows the rest of the teams. Orlando Pride has only 2 forwards but a cap total of 293, the second highest. Lyon and Bayern Munich feature with 4 forwards as well with 254 and 160 caps respectively. Chelsea and Arsenal feature again, but the American clubs Portland Thorns and Orlando Pride really take the cake here.


## Performance of successful clubs in the 2019 World Cup

So far, we have seen a few clubs contributing greatly towards providing high scoring and highly experienced (caps) international players. Few of these clubs we can shortlist - Portland Thorns, Orlando Pride, Lyon, Arsenal, Barcelona, Chelsea, Manchester City and Paris Saint-Germain. All of these clubs have players representing various countries, so let us use our 2019 World Cup match results data to understand which of these contributed to world cup success.


### Goals scored by nations in the world cup

Let us see the goal scoring performance of all teams in 2019 world cup.

```{r attack}

outcomes_2019 <- wwc_outcomes %>% 
  filter(year == 2019)

best_attack <- outcomes_2019 %>% 
  group_by(team) %>% 
  summarise(goals = sum(score)) %>% 
  arrange(desc(goals))

best_attack %>%
  head(10) %>% 
  kable(booktabs = TRUE, caption = "Top Goal Scoring Nations") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```


Looking into table \@ref(tab:attack), the USA scored a whopping 26 goals in the 2019 World Cup. That is twice the number of goals scored by the second highest scoring nation, England. Even though 13 of those goals were scored in one match, against Thailand, it is still a large number considering it was done in only 7 matches. This keeps in line with what we saw previously, that the USA has the best goal scoring clubs, with Portland Thorns and Orlando Pride dominating goal numbers.


### World Cup progress

```{r round}

round <- c("Group", "Round of 16", "Quarter Final", "Semi Final", "Third Place Playoff", "Final")
label <- c(1, 2, 3, 4, 4, 5)

round_label <- data.frame(round, label)

outcomes_2019 <- outcomes_2019 %>% left_join(round_label, by = "round")

prog <- outcomes_2019 %>% 
  group_by(team) %>% 
  summarise(round = max(label, na.rm = FALSE)) %>% 
  arrange(desc(round))
```

```{r progress, fig.cap="Teams Progression In The 2019 World Cup"}

prog_plot <- prog %>% 
  ggplot(aes(round, reorder(team, -round), color = "red")) + 
  geom_point() +
  xlab("Round") +
  ylab("Teams") +
  ggtitle("Teams Progression In The 2019 World Cup") +
  theme_bw() +
  theme(legend.position = "none")

ggplotly(prog_plot)

```

Figure \@ref(fig:progress) represents the final results of the 2019 Women's World Cup. Each number on the x axis represents the subsequent round - 1 being group stage and 5 being the final.

The USA won their second world cup in a row, beating the Netherlands in the final. In the semi finals, England and Sweden were the casualties, losing out to the USA and Netherlands respectively. They did play a third place match which Sweden won. 


# Conclusion

Barcelona and Lyon provide the most number of world cup players, with 15 and 14 respectively. 10 Barcelona players out of those 15 were Spanish, although Spain were eliminated in the round of 16 by the eventual winners - the USA. Lyon provided 7 French nationals in the world cup, and France were eliminated in the quarter finals, again by the USA.

The USA scored a massive 26 goals in the tournament's 7 matches, which can be justified by the fact that just 2 American clubs - Portland Thorns and Orlando Pride, both have nearly 500 international goals between them.

In terms of experience, Christian Sinclair and Carli Lloyd from Portland Thorns and Sky Blue FC (the latter an American club again), are the most capped, with 282 and 271 caps respectively. The top 5 capped players are all above 30 years of age, although there are young players (25 or below) that already have a lot of international experience under their belts, like the 24 year old Chinese midfielder Wang Shuang (93 caps) who plays for Paris Saint-Germain.

In terms of positional contribution, Chelsea dominates goalkeepers with their 2 goalkeepers featuring in the world cup, boasting 173 caps between them. Lyon and Chelsea have 7 and 6 defenders respectively and 475 and 404 caps. Vfl Wolfsburg has 4 midfielders with 366 caps between them. Barcelona has 5 forwards featuring in the world cup who had 249 goals between them, although Spain scored only 4 goals in their 4 matches. Portland Thorns on the other hand had 4 forwards with 534 goals between them, and the USA scored 26 goals in the world cup.

Finally, considering the sheer number of goals scored, the USA deservingly won the world cup, eliminating the likes of Spain, France, England and Netherlands in the process. Netherlands came in second, losing the final to USA and Sweden came in third, beating England in the third place playoffs.

# Acknowledge

The packages used are as follows:


- ggpplot2 [@ggplot2]

- tidyverse [@tidyverse]

- kableExtra [@kableExtra]

- bookdown [@bookdown]

- dplyr [@dplyr]

- plotly [@plotly]


# References

Contibution of world cup players by clubs from 2007 to 2019

https://www.reuters.com/article/us-soccer-world-fifa/fifa-to-pay-clubs-209-million-for-world-cup-collaboration-idUSKBN0MG1I320150320

https://img.fifa.com/image/upload/imn0xwvea97tommxx5uz.pdf
