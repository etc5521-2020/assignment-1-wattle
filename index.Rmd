---
title: "ETC5521 Assignment 1"
subtitle: "Contribution of domestic clubs towards world cup success in women's soccer"
team: wattle
author:
  - Ketan Kabu  31554679
  - Yiwen Zhang 31203019
date: "`r Sys.Date()`"
bibliography: references.bib
biblio-style: authoryear-comp
output: 
  bookdown::html_document2:
   citation_package: biblatex
   toc: TRUE
---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE, message=FALSE,warning = FALSE,comment = FALSE,fig.pos = 'H')

library(ggplot2)
library(tidyverse)
library(dplyr)
library(plotly)
library(bookdown)
library(ggridges)
library(colorspace)
library(plotly)
library(GGally)
library(kableExtra)
```

```{r readdata}
wwc_outcomes <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-07-09/wwc_outcomes.csv")
squads <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-07-09/squads.csv")
codes <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-07-09/codes.csv")

df <- read.csv("https://query.data.world/s/va6hy244mzxtoc7c3ww3nracqhreab", header=TRUE, stringsAsFactors=FALSE)
```




# Introduction and motivation

Women's soccer has gained a lot of media attention in the last few years, and deservingly so. Countries like the USA, a dominant force in women's soccer, have produced some top quality players like Megan Rapinoe, Carli Lloyd, Alex Morgan and Julie Ertz. Just north of the USA, Christine Sinclair from Canada became the first player to win the Lou Marsh Award as Canadian Athlete of the Year, which is unsurprising considering her outstanding haul of 182 career international goals. Ada Hegerberg from Norway became the first woman to win the prestigious Ballon d'Or award, an yearly honor awarded to best player in the world, which was first introduced for the women's game in 2018.[@sportmob2020]

The advancement of women's soccer has been parallel with the understanding and acceptance of data and analytics in the game. The technological advancement in capturing and analysing data has exploded since the late 1990s, when it began. Clubs have used this technology to identify and scout talent from all over the world.

Every country has a different approach towards coaching and developing talent. Success at an international level could be down to the ability of world class players playing with a certain level of chemistry, which could be challenging as it is common for them to be playing for different rival clubs at the domestic level. In the men's game, we saw Italy, Spain and Germany winning world cups in 2006, 2010 and 2014 respectively. Many partly attributed the success of these teams towards the fact that majority of these players playing in the same domestic league (or country), or even in the same club, especially those clubs that produce the most successful international players.

In this paper, we will approach the women's game with the same lens. We believe that these findings could prove meaningful to coaches, scouts and even young players in the game looking to choose clubs to play for with future international success in mind.

Limitations - The squad data that we had access to had only the 2019 world cup team rosters, which is why we could only focus on the 2019 world cup matches. If similar dataset for all world cups is obtained, analysis can be done on all world cups and a trend observation can produce deeper insights about how nations have progressed in women's soccer. 
There is also a need to assess players' performance not solely on the basis of goals they scored. Midfielders, Defenders and Goalkeepers have various other parameters they can be judged on - like assists, distance covered in a match, tackles, clearances, saves(goalkeepers) and various others. If this information is available, better player performance insights can be achieved. 
We could also do match by match analysis of the world cup if we can obtain information about how each player was rated, or scored certain number of goals, in a world cup match.
In our clubs data, we have a reference named as "Unattached", which will appear sometimes in our analysis. This signifies that the player(s) is not contracted with any domestic club when the data was collected.


# Data description

This dataset is about Women's World Cup, which originally comes from website data.world <https://data.world/sportsvizsunday/womens-world-cup-data>.It consists of final score and win/loss status data from 1991-2019. Additionally, the 2019 world cup rosters for each team are included. After being cleaned by Thomas Mock at tidy tuesday challenge, we downloaded the two dataset from his github at <https://github.com/rfordatascience/tidytuesday/tree/master/data/2019/2019-07-09>. Figure \@ref(fig:miss-data) shows the missing data for squads.

```{r outcome-data, warning=FALSE, message=FALSE}
outcome_data <- tibble(Variable = c("year", "team", "score", "round", "yearly_game_id","team_num","win_status"),
                          Class = c( "double",  "character", "double","character", "integer", "double",  "character"),
                          Description = c("Year of tournamente", 
                                          "Abbreviated team", 
                                          "Score by team", 
                                          "Round of the tournament", 
                                          "Grouping variable - pairs team 1 and team 2 by round/year","team num (1 or 2)","Win Status = win/lose or tie (group only)")) 
outcome_data %>%
  kable(caption = "Woman world cup outcome data") %>%
  kable_styling(bootstrap_options = "striped", 
                full_width = F, 
                position = "center")
```

```{r outcome-data, warning=FALSE, message=FALSE}
squads_data <- tibble(Variable = c("squad_no", "country", "pos", "player", "dob","age","caps","goals","club"),
                          Class = c( "double",  "character","character","character", "date", "double", "double","double", "character"),
                          Description = c("Squad number (1 through 23)", 
                                          "Country", 
                                          "position", 
                                          "Player name", 
                                          "date of birth",
                                          "age (years)",
                                          "caps - international games played","Goals - international goals scored","Professional Club")) 
squads_data %>%
  kable(caption = "squads data") %>%
  kable_styling(bootstrap_options = "striped", 
                full_width = F, 
                position = "center")
```

```{r miss-data,fig.cap="Missing data for squads"}
visdat::vis_miss(squads)
```

For the "squads" dataset, we made two improvements:
- The missing value for the caps and goals were mostly of the China PR, Nigeria and Cameroon teams. We had managed to find and added the missing caps and goals for the China PR team from Wikipedia which can be found [here](https://en.wikipedia.org/wiki/2019_FIFA_Women%27s_World_Cup_squads).  
- Asides from the squads information of 2019 that was provided, we tried to expand the dataset to include the information of thep previous World Cups. Information was gathered manually by hands from Wikipedia and stored in a csv file before merged with the squads information of 2019. The new dataset now has the new dimension as below:  

```{r clean-squads}
# load the squad information for the remaining world cups
wc_squad_full <- read.csv(here::here("femalewwc_squad.csv")) %>%
  mutate(dob = as.Date(dob, format = "%d-%B-%Y"))

# Update missing info for squads_raw
squads <- squads %>%
  mutate(
    caps = case_when(
    str_detect(player, "Xu Huan") ~ 1,
    str_detect(player, "Lin Yuping") ~ 13,
    str_detect(player, "Wang Yan") ~ 28,
    str_detect(player, "Wang Ying") ~ 4,
    str_detect(player, "Li Wen") ~ 32,
    str_detect(player, "Bi Xiaolin") ~ 35,
    str_detect(player, "Yao Wei") ~ 14,
    str_detect(player, "Luo Guiping") ~ 1,
    str_detect(player, "Liu Yanqiu") ~ 2,
    TRUE ~ caps
  ),
  goals = case_when(
    str_detect(player, "Xu Huan") ~ 0,
    str_detect(player, "Lin Yuping") ~ 0,
    str_detect(player, "Wang Yan") ~ 0,
    str_detect(player, "Wang Ying") ~ 0,
    str_detect(player, "Li Wen") ~ 3,
    str_detect(player, "Bi Xiaolin") ~ 0,
    str_detect(player, "Yao Wei") ~ 3,
    str_detect(player, "Luo Guiping") ~ 0,
    str_detect(player, "Liu Yanqiu") ~ 0,
    TRUE ~ goals)
  )
    
# row binds with 2019 squad info
squads <- squads %>%
  mutate(year = 2019) 
squads <- squads %>%
  rbind(wc_squad_full)

# manually fix the name of some clubs to avoid mismatch
squads <- squads %>%
  mutate(club = case_when(
    str_detect(club, "Olympique Lyon") ~ "Lyon",
    str_detect(club, "Olympique Lyonnais") ~ "Lyon",
    str_detect(club, "Ajax") ~ "AFC Ajax",
    str_detect(club, "AIK Fotboll") ~ "AIK",
    str_detect(club, "Asker S.K.") ~ "Asker SK",
    str_detect(club, "Avaldsnes") ~ "Avaldsnes IL",
    str_detect(club, "Bangkok F.C.") ~ "Bangkok",
    str_detect(club, "Klepp") ~ "Klepp IL",
    str_detect(club, "Urawa Red Diamonds") ~ "Urawa Red Diamonds Ladies",
    str_detect(club, "Urawa Reds Ladies") ~ "Urawa Red Diamonds Ladies",
    str_detect(club, "Linköping FC") ~ "Linköping",
    str_detect(club, "Arna-Bjørnar") ~ "Arna-Bjornar",
    str_detect(club, "Arsenal L.F.C.") ~ "Arsenal",
    str_detect(club, "Bayelsa Queens FC") ~ "Bayelsa Queens",
    str_detect(club, "Beijing Chengjian") ~ "Beijing Chenjian",
    str_detect(club, "Birmingham City L.F.C.") ~ "Birmingham City",
    str_detect(club, "Changchun Zhuoyue [zh]") ~ "Changchun Zhuoyue",
    str_detect(club, "Chelsea L.F.C.") ~ "Chelsea",
    str_detect(club, "Delta Queens FC") ~ "Delta Queens",
    str_detect(club, "Djurgården") ~ "Djurgårdens IF",
    str_detect(club, "Doncaster Rovers Belles LFC") ~ "Doncaster Rovers Belles",
    str_detect(club, "Eastern Suburbs AFC") ~ "Eastern Suburbs",
    str_detect(club, "Everton L.F.C.") ~ "Everton",
    str_detect(club, "FC Barcelona") ~ "Barcelona",
    str_detect(club, "FFC Frankfurt") ~ "1. FFC Frankfurt",
    str_detect(club, "FFC Turbine Potsdam") ~ "1. FFC Turbine Potsdam",
    str_detect(club, "KIF Örebro DFF") ~ "KIF Örebro",
    str_detect(club, "Kolbotn Fotball") ~ "Kolbotn",
    str_detect(club, "Kristianstads DFF") ~ "Kristianstads",
    str_detect(club, "Levante UD") ~ "Levante",
    str_detect(club, "Louves Miniproff [de]") ~ "Louves Minproff",
    str_detect(club, "LSK Kvinner FK") ~ "LSK Kvinner",
    str_detect(club, "Melbourne Victory FC") ~ "Melbourne Victory",
    str_detect(club, "Montpellier") ~ "Montpellier",
    str_detect(club, "Nasarawa Amazons FC") ~ "Nasarawa Amazons",
    str_detect(club, "Pelican Stars FC") ~ "Pelican Stars",
    str_detect(club, "Piteå") ~ "Piteå",
    str_detect(club, "Rivers Angels FC") ~ "Rivers Angels",
    str_detect(club, "Sevilla FC") ~ "Sevilla",
    str_detect(club, "Sky Blue FC") ~ "Sky Blue",
    str_detect(club, "Stabæk Fotball") ~ "Stabæk",
    str_detect(club, "Tianjin Teda F.C.") ~ "Tianjin Teda",
    str_detect(club, "Trondheims-Ørn SK") ~ "Trondheims-Ørn",
    str_detect(club, "Tyresö FF") ~ "Tyresö",
    str_detect(club, "Umeå IK") ~ "Umeå",
    str_detect(club, "Valencia CF") ~ "Valencia",
    str_detect(club, "Vegalta Sendai") ~ "Vegalta Sendai Ladies",
    str_detect(club, "Vittsjö GIK") ~ "Vittsjö",
    str_detect(club, "Wuhan Jianghan University [zh]") ~ "Wuhan Jianghan Univ.",
    str_detect(club, "SwedenJitex BK") ~ "Jitex BK",
    str_detect(club, "EnglandNotts County") ~ "Notts County",
    TRUE ~ club
  ))

glimpse(squads)
```

After we joined the two datasets, once again we checked the missing values for this newly created "squads"

```{r miss-data,fig.cap="Missing data for squads"}
visdat::vis_miss(squads)
```

The information of caps, goals and clubs were mostly not available for the World Cup that took place too long ago. In each analysis, we will filter only the years that have suffice information to respond to the tasks on hand.  

# Analysis and findings

Main question:

- What factor affect the performance of the football team in the world cup?

The analysis is mainly divided into three parts, which answer the three secondary questions, and they are :
- Which are the clubs that provide the most number of world cup players?

- How about contribution by clubs in terms of players' caps and positions?

- How is the performance of successful clubs in the 2019 World Cup?


## Analysis the performance of woman world cup by country
### Overall summary trend of the number of goals scored by the country
```{r score-dis,fig.cap="Nation goals distribution"}
wwc_outcomes_2019 <- wwc_outcomes %>% 
  group_by(team,year) %>% 
  summarise(score = sum(score))
  
p1 <- ggplot(wwc_outcomes_2019, aes(score, team)) +  
  geom_density_ridges() + 
  geom_point() + 
  labs(y = "Country", x= "score")+
  theme(axis.text.y = element_text(color = "grey",face = "bold"),
        plot.title = element_text(face = "bold"),
        plot.background = element_rect(fill="white"),
        panel.background = element_rect(fill="white"))
p1
```

Looking into figure \@ref(fig:score-dis), the USA and Germany score significantly more goals each year than other countries, the kurtosis reflects the central tendency. The more right the kurtosis, the more goals are scored. The point shows the total number of goals scored by different countries each year. It can be seen that the most happened in the United State.

```{r data-process}

  wwc_outcomes_ROUND <- wwc_outcomes%>% 
   mutate(Round = case_when(
      str_detect(round, "Group") ~ "G",
      str_detect(round, "Quarter Final") ~ "Q",
      str_detect(round, "Semi Final") ~ "S",
      str_detect(round, "Third Place Playoff") ~ "T",
      str_detect(round, "Final") ~ "F",
      str_detect(round, "Round of 16") ~ "R"
      )) 

```

### General summary of the promotion of the National Women's World Cup

```{r exp-layout, fig.width = 15, fig.height = 8, fig.cap = "Experimental layout. Each cell represents an experimental unit for each categorised behaviour. The number written in the cell shows the number of observations recorded and the color of the cell shows the treatment applied to the calve."}

options(repr.plot.width = 12, repr.plot.height = 18)
 wwc_outcomes_ROUND  %>% 
  ggplot(aes(year, Round),height = "120%") + 
  geom_tile(color = "black", aes(fill = win_status)) + 
  #geom_text(aes(label = Round)) + 
  #facet_wrap(~team) + 
  facet_wrap( ~team) +
  scale_fill_discrete_qualitative() + 
  scale_color_manual(values = c("black", "brown")) +
  coord_equal() + 
  theme_classic(base_size =12) + 
  guides(color = FALSE) + 
  labs(fill = "Win_status", y = "Round", x = "Year")
```
Figure \@ref(fig:exp-layout) show the promotion situation for all the country attend the woman world cup between 1991 and 2019, the color represents the win, lose or tie, Each row represents a different stage of the game, such as group matches, semi-finals or final. It is clear to see that the United States has only lost four times in the past 20 years, The United States is a strong opponent in the Women's World Cup, followed by Germany, Although the number of losses is greater than that of the United States, Germany has also won many times. Figure \@ref(fig:exp-layout clearly sees the situation of each country. It can be seen that in women's football, the strength of different countries is very different. Why does this happen? What factors affect this phenomenon?

## More score, more change to get the champion

### Total goals scored by different countries

```{r map-count, fig.cap = "Total goals scored by different countries"}

whole_code <- wwc_outcomes %>% 
  left_join(codes) %>% 
   # filter(round =="Group") %>% 
  mutate(country= as.character(country),
        country = if_else(country %in% c("China PR","Chinese Taipei"), "China", country),
        country = if_else(country %in% "United States", "USA", country),
        country = if_else(country %in% "England","UK", country),
        country = if_else(country %in% "Ivory Coast (Côte d'Ivoire)","Ivory Coast", country)) %>% 
  group_by(country) %>% 
  summarise(total_score = sum(score))
  
  
world_map <- map_data("world")

numofplayers <- world_map %>% 
  mutate(region = as.character(region)) %>% 
  left_join(whole_code,by = c("region"="country")) 
  

 
numofplayers[is.na(numofplayers)] <- 0

p2 <- ggplot(numofplayers, aes(long, lat, group = group,label = region))+
    geom_polygon(aes(fill = total_score ), color = "white")+
    scale_fill_viridis_c(option = "C")+
    theme_void()+
    labs(fill = "Total number of goals",
         title = "Number of goals with different countries")+
   theme(
    legend.position = c(.20, .30),
    legend.box.just = c("right","bottom"))+
   theme(axis.text.y = element_text(color = "grey", 
                                             face = "bold"),
        plot.title = element_text(face = "bold"),
        plot.background = element_rect(fill="white"),
        panel.background = element_rect(fill="white"))

ggplotly(p2)
```

Figure \@ref(fig:map-count) is an interactive map. Click on the location on the map, and we can see the country's name and the total number of goals scored in the World Cup. The color also indicates the number of goals. USA, Germany, and Norway those three countries have the most number of total goals, especially compared to other countries. Does the total number of goals have anything to do with the chance of winning the championship? Will the country with more goals win the game? 

### THe relationship between total score and chance of winning

```{r Correlation,fig.cap="Correlation analysis"}
new_num <- numofplayers %>% 
  select(region,total_score) %>% 
  filter(total_score >0) %>% 
  distinct()


new_wwc <- wwc_outcomes %>% 
  left_join(codes)%>% 

    mutate(country= as.character(country),
        country = if_else(country %in% c("China PR","Chinese Taipei"), "China", country),
        country = if_else(country %in% "United States", "USA", country),
        country = if_else(country %in% "England","UK", country),
        country = if_else(country %in% "Ivory Coast (Côte d'Ivoire)","Ivory Coast", country)) %>% 
    filter(win_status=="Won") %>% 
  filter(round == "Final") %>% 
  # 用胜利的次数作为表现好的体现
  group_by(country) %>% 
  summarise(total = sum(score)) %>% 
    
  left_join(new_num,by = c("country"="region")) %>% 
  select(-country)

p3 <- ggpairs(new_wwc, title="correlogram with ggpairs()") +
  theme(axis.text.y = element_text(color = "grey", 
                                             face = "bold"),
        plot.title = element_text(face = "bold"),
        plot.background = element_rect(fill="white"),
        panel.background = element_rect(fill="white"))

ggplotly(p3)

```

Figure \@ref(fig:Correlation) is a correlation analysis between total goals and change to win, The correlation coefficient is 0.768, which shows a positive correlation, that is, the more the total number of goals, the greater the chance of winning the championship.







# Conclusion

Barcelona and Lyon provide the most number of world cup players, with 15 and 14 respectively. 10 Barcelona players out of those 15 were Spanish, although Spain were eliminated in the round of 16 by the eventual winners - the USA. Lyon provided 7 French nationals in the world cup, and France were eliminated in the quarter finals, again by the USA.

The USA scored a massive 26 goals in the tournament's 7 matches, which can be justified by the fact that just 2 American clubs - Portland Thorns and Orlando Pride, both have nearly 500 international goals between them.

In terms of experience, Christian Sinclair and Carli Lloyd from Portland Thorns and Sky Blue FC (the latter an American club again), are the most capped, with 282 and 271 caps respectively. The top 5 capped players are all above 30 years of age, although there are young players (25 or below) that already have a lot of international experience under their belts, like the 24 year old Chinese midfielder Wang Shuang (93 caps) who plays for Paris Saint-Germain.

In terms of positional contribution, Chelsea dominates goalkeepers with their 2 goalkeepers featuring in the world cup, boasting 173 caps between them. Lyon and Chelsea have 7 and 6 defenders respectively and 475 and 404 caps. Vfl Wolfsburg has 4 midfielders with 366 caps between them. Barcelona has 5 forwards featuring in the world cup who had 249 goals between them, although Spain scored only 4 goals in their 4 matches. Portland Thorns on the other hand had 4 forwards with 534 goals between them, and the USA scored 26 goals in the world cup.

Finally, considering the sheer number of goals scored, the USA deservingly won the world cup, eliminating the likes of Spain, France, England and Netherlands in the process. Netherlands came in second, losing the final to USA and Sweden came in third, beating England in the third place playoffs.

# Acknowledge

The packages used are as follows:


- ggpplot2 [@ggplot2]

- tidyverse [@tidyverse]

- kableExtra [@kableExtra]

- bookdown [@bookdown]

- dplyr [@dplyr]

- plotly [@plotly]


# References


